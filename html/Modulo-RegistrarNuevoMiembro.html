<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../img/sares.jpeg" type="image/x-icon">
    <link rel="stylesheet" href="../css/genericDesign.css">
    <link rel="stylesheet" href="../css/Modulo-RegistrarNuevoMiembro.css">
    <title>Edicion Miembros</title>
</head>

<body>
    <div class="header">
        <div class="logos">
            <img src="../img/sep.png" alt="Logo SEP">
            <img src="../img/tecnm.jpg" alt="TECNM Logo">
            <img src="../img/tec.png" alt="ITL Logo">
            <img src="../img/sares.jpeg" alt="SARES Logo">
        </div>
        <div class="user-profile" onclick="toggleMenu()">
            <img src="" alt="Foto de Perfil" id="profileImage">
            <span class="menu-icon"><img src="../img/list.svg"></span>
        </div>
        <div class="menu-dropdown" id="menuDropdown">
            <ul id="menuList">
                <!-- Contenido dinámico del menú -->
            </ul>
        </div>
    </div>

    <!--main content-->
    <div class="main-content">
        <div class="user-role">Administrador de sistema</div>
        <div class="page-title">Registrar Nuevo Miembro</div>

        <div class="action-bar">
            <div class="entries-container">
                <span>Mostrar</span>
                <select class="entries-dropdown" id="entries-dropdown">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>entradas por página</span>
            </div>

            <button class="btn btn-primary" id="new-member-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-right: 5px; vertical-align: text-top;">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Registrar Nuevo Miembro
            </button>

            <div class="search-container">
                <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </span>
                <input type="text" placeholder="Buscar..." id="search-input">
            </div>
        </div>

        <div class="table-container">
            <table class="data-table" id="members-table">
                <thead>
                    <tr>
                        <th class="sortable">Clave</th>
                        <th class="sortable">Nombre</th>
                        <th class="sortable">Correo</th>
                        <th class="sortable">Género</th>
                        <th class="sortable">Tipo</th>
                        <th class="sortable">Edad</th>
                        <th class="sortable">Área</th>
                        <th class="sortable">Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos se cargarán dinámicamente con JavaScript -->
                </tbody>
            </table>

            <div class="pagination">
                <div class="pagination-info" id="pagination-info">Mostrando 1 a 5 de 5 entradas</div>
                <button class="pagination-btn" id="prev-page">&lt;</button>
                <button class="pagination-btn active">1</button>
                <button class="pagination-btn" id="next-page">&gt;</button>
            </div>
        </div>
    </div>

    <div class="footer">© Sares TL, 2024</div>

    <!-- Modal para añadir/editar miembro -->
    <div class="modal-overlay" id="member-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Registrar Nuevo Miembro</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="member-form">
                    <input type="hidden" id="edit-mode" value="false">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="member-clave" class="required">Clave</label>
                            <input type="text" class="form-control" id="member-clave" required>
                        </div>
                        <div class="form-group">
                            <label for="member-nombre" class="required">Nombre</label>
                            <input type="text" class="form-control" id="member-nombre" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="member-correo" class="required">Correo</label>
                            <input type="email" class="form-control" id="member-correo" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Género</label>
                            <div style="margin-top: 8px;">
                                <label class="gender-option">
                                    <input type="radio" name="member-genero" value="Masculino" required> Masculino
                                </label>
                                <label class="gender-option">
                                    <input type="radio" name="member-genero" value="Femenino"> Femenino
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="member-tipo" class="required">Tipo</label>
                            <select class="form-control" id="member-tipo" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Docente">Docente</option>
                                <option value="Estudiante">Estudiante</option>
                                <option value="Guardia">Guardia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="member-edad" class="required">Edad</label>
                            <input type="number" class="form-control" id="member-edad" min="18" max="100" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="member-area" class="required">Área</label>
                            <input type="text" class="form-control" id="member-area" required>
                        </div>
                        <div class="form-group">
                            <label for="member-estado" class="required">Estado</label>
                            <select class="form-control" id="member-estado" required>
                                <option value="">Seleccionar estado</option>
                                <option value="Activo">Activo</option>
                                <option value="No Activo">No Activo</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal-btn">Cancelar</button>
                <button class="btn btn-save" id="save-member">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Función para alternar el menú desplegable
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('open');
        }

        // Función para obtener datos del usuario y generar contenido dinámico
        async function obtenerDatosUsuario() {
            const user = sessionStorage.getItem('user'); // Obtener el ID del usuario

            // Verifica si el usuario no está autenticado
            if (!user) {
                alert('No has iniciado sesión. Redirigiendo al login...');
                window.location.href = "../html/Modulo-InicioSesion.html"; // Redirección al login
                return;
            }

            // URL del API para obtener tipo de usuario
            const apiUrl = 'https://hugoc.pythonanywhere.com/api/usertype';

            try {
                // Realiza la solicitud POST para obtener el tipo de usuario
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user }),
                });

                const data = await response.json();
                if (response.ok && data.status === "success") {
                    const userRoleNumber = data.userRole ?? '';
                    const userName = data.userName ?? '';
                    const userTypeInst = data.userTypeInst ?? '';

                    try {
                        // Realiza la solicitud para obtener la imagen del usuario
                        const apiUrlPicture = 'https://hugoc.pythonanywhere.com/api/userPicture';
                        const responsePicture = await fetch(apiUrlPicture, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ user }),
                        });
                        const dataPicture = await responsePicture.json();

                        if (responsePicture.ok && dataPicture.status === "success") {
                            const userPicture = dataPicture.userPicture ?? '';

                            // Verifica que profileImage exista en el DOM
                            const profileImage = document.querySelector('.user-profile img');
                            if (profileImage) {
                                profileImage.src = userPicture; // Actualiza la imagen de perfil
                            } else {
                                console.error('No se encontró el elemento de la imagen de perfil');
                            }
                        } else {
                            console.error('Error al obtener la imagen de perfil:', dataPicture.message);
                        }

                    } catch (errorP) {
                        console.error('Error en la solicitud de la imagen de perfil:', errorP);
                        alert('Hubo un problema al conectar con el servidor para obtener la imagen de perfil. Intenta nuevamente.');
                    }
                    switch (userRoleNumber) {
                        case 1:
                            generarMenu('Estudiante');
                            break;
                        case 2:
                            generarMenu('Docente');
                            break;
                        case 3:
                            generarMenu('Administrador');
                            break;
                        case 4:
                            generarMenu('Administrativo');
                            break;
                        case 5:
                            generarMenu('Intendente');
                            break;
                        case 6:
                            generarMenu('Guardia');
                            break;
                        default:
                            console.error('Rol de usuario desconocido');
                            alert('No se pudo determinar el rol del usuario.');
                            window.location.href = "../html/Modulo-InicioSesion.html"; // Redirige si hay error
                            break;
                    }

                } else {
                    console.error('Error al obtener tipo de usuario:', data.message);
                    alert('Hubo un problema al obtener el tipo de usuario. Intenta nuevamente.');
                    window.location.href = "../html/Modulo-InicioSesion.html"; // Redirige si la respuesta no es correcta
                }

            } catch (error) {
                console.error('Error en la solicitud principal:', error);
                alert('Hubo un problema al conectar con el servidor. Intenta nuevamente.');
                window.location.href = "../html/Modulo-InicioSesion.html"; // Redirige en caso de error
            }

        }

        // Función para generar el menú dinámico según el rol del usuario
        function generarMenu(userRole) {
            const menuDropdown = document.getElementById('menuDropdown');
            //const menuList = menuDropdown.querySelector('ul');

            // Generar contenido según el rol del usuario
            if (userRole === 'Administrador') {
                menuList.innerHTML = `
                    <li><a href="../html/Modulo-Bienvenida.html">Panel Principal</a></li>
                    <li><a href="../html/Modulo-VisualizacionGeneral.html">Visualización Entradas y Salidas</a></li>
                    <li><a href="../html/Modulo-RevisarHistorial.html">Revisar Historial Personal</a></li>
                    <li><a href="../html/Modulo-RegistrarNuevoMiembro.html">Registrar Miembro Institución</a></li>
                    <li><a href="../html/Modulo-Perfil.html">Perfil</a></li>                    
                    <li><a href="../html/Modulo-ManualUsuario.html">Manual de Usuario</a></li>
                    <li><a href="../html/Modulo-InicioSesion.html" onclick="logOut()">Cerrar Sesión</a></li>
                `;
            } else if (userRole == 'Guardia') {
                menuList.innerHTML = `
                    <li><a href="../html/Modulo-Bienvenida.html">Panel Principal</a></li>
                    <li><a href="../html/Modulo-RegistroAccesos.html">Registro Accesos</a></li>   
                    <li><a href="../html/Modulo-VisualizacionGeneral.html">Visualización Entradas y Salidas</a></li>
                    <li><a href="../html/Modulo-RevisarHistorial.html">Revisar Historial Personal</a></li>
                    <li><a href="../html/Modulo-Perfil.html">Perfil</a></li>                    
                    <li><a href="../html/Modulo-ManualUsuario.html">Manual de Usuario</a></li>
                    <li><a href="../html/Modulo-InicioSesion.html" onclick="logOut()">Cerrar Sesión</a></li>
                `;

            } else {
                menuList.innerHTML = `
                    <li><a href="../html/Modulo-Bienvenida.html">Panel Principal</a></li>                                          
                    <li><a href="../html/Modulo-RevisarHistorial.html">Revisar Historial Personal</a></li>
                    <li><a href="../html/Modulo-Perfil.html">Perfil</a></li>                    
                    <li><a href="../html/Modulo-ManualUsuario.html">Manual de Usuario</a></li>
                    <li><a href="../html/Modulo-InicioSesion.html" onclick="logOut()">Cerrar Sesión</a></li>
                `;
            }
        }
        function logOut() {
            // Limpiar el sessionStorage y redirigir al inicio de sesión
            sessionStorage.clear();
        }

        // Llamar a la función al cargar la página
        obtenerDatosUsuario();

        // Datos de ejemplo eliminados, vamos a obtenerlos desde la API

        // Referencias a elementos DOM
        const membersTable = document.getElementById('members-table');
        const paginationInfo = document.getElementById('pagination-info');
        const searchInput = document.getElementById('search-input');
        const entriesDropdown = document.getElementById('entries-dropdown');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const memberModal = document.getElementById('member-modal');
        const modalTitle = document.getElementById('modal-title');
        const memberForm = document.getElementById('member-form');
        const editModeInput = document.getElementById('edit-mode');
        const newMemberBtn = document.getElementById('new-member-btn');

        // Datos iniciales
        let membersData = [];

        // Función para obtener miembros de la API
        async function fetchMembers() {
            try {
                const response = await fetch('https://hugoc.pythonanywhere.com/api/obtain_institution_members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    membersData = data.members; // Asignamos los miembros a la variable global
                    filteredData = [...membersData]; // Asignamos a los datos filtrados
                    renderTable(); // Renderizamos la tabla con los nuevos datos
                } else {
                    alert('Error al obtener los miembros: ' + data.message);
                }
            } catch (error) {
                console.error('Error al obtener los miembros:', error);
                alert('Hubo un problema al obtener los datos.');
            }
        }

        // Función para renderizar la tabla
        function renderTable() {
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = startIndex + entriesPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            const tableBody = membersTable.querySelector('tbody');
            tableBody.innerHTML = '';

            paginatedData.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${member.clave}</td>
            <td>${member.nombre}</td>
            <td>${member.correo}</td>
            <td>${member.genero}</td>
            <td>${member.tipo}</td>
            <td>${member.edad}</td>
            <td>${member.area}</td>
            <td>
                <span class="badge ${member.estado === 'Activo' ? 'badge-success' : 'badge-danger'}">
                    ${member.estado}
                </span>
            </td>
            <td>
                <button class="btn btn-edit" data-clave="${member.clave}">Editar</button>
            </td>
        `;
                tableBody.appendChild(row);
            });

            const totalEntries = filteredData.length;
            const firstEntryIndex = totalEntries === 0 ? 0 : startIndex + 1;
            const lastEntryIndex = Math.min(startIndex + entriesPerPage, totalEntries);

            paginationInfo.textContent = `Mostrando ${firstEntryIndex} a ${lastEntryIndex} de ${totalEntries} entradas`;

            // Configurar botones de edición
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', () => {
                    const clave = btn.getAttribute('data-clave');
                    openEditModal(clave);
                });
            });
        }

        // Función para abrir el modal en modo edición
        function openEditModal(clave) {
            const member = membersData.find(m => m.clave === clave);

            if (member) {
                editModeInput.value = 'true';
                modalTitle.textContent = 'Editar Miembro';

                // Llenar el formulario con los datos del miembro
                document.getElementById('member-clave').value = member.clave;
                document.getElementById('member-nombre').value = member.nombre;
                document.getElementById('member-correo').value = member.correo;
                document.querySelector(`input[name="member-genero"][value="${member.genero}"]`).checked = true;
                document.getElementById('member-tipo').value = member.tipo;
                document.getElementById('member-edad').value = member.edad;
                document.getElementById('member-area').value = member.area;
                document.getElementById('member-estado').value = member.estado;

                memberModal.classList.add('active');
            }
        }

        // Función para guardar un miembro (nuevo o editado)
        function saveMember() {
            const clave = document.getElementById('member-clave').value;
            const nombre = document.getElementById('member-nombre').value;
            const correo = document.getElementById('member-correo').value;
            const genero = document.querySelector('input[name="member-genero"]:checked').value;
            const tipo = document.getElementById('member-tipo').value;
            const edad = parseInt(document.getElementById('member-edad').value);
            const area = document.getElementById('member-area').value;
            const estado = document.getElementById('member-estado').value;

            const member = {
                clave,
                nombre,
                correo,
                genero,
                tipo,
                edad,
                area,
                estado
            };

            const isEditMode = editModeInput.value === 'true';

            if (isEditMode) {
                // Actualizar miembro existente
                const index = membersData.findIndex(m => m.clave === clave);
                if (index !== -1) {
                    membersData[index] = member;
                }
            } else {
                const exists = membersData.some(m => m.clave === clave);
                if (exists) {
                    alert('¡Error! Ya existe un miembro con esa clave.');
                    return;
                }
                membersData.push(member);
            }

            filteredData = [...membersData];
            if (searchInput.value) {
                filterData();
            } else {
                renderTable();
            }

            closeModal();
        }

        // Función para cerrar el modal
        function closeModal() {
            memberModal.classList.remove('active');
            memberForm.reset();
        }

        // Event listeners
        searchInput.addEventListener('input', filterData);
        entriesDropdown.addEventListener('change', () => {
            entriesPerPage = parseInt(entriesDropdown.value);
            currentPage = 1;
            renderTable();
        });
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / entriesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });
        newMemberBtn.addEventListener('click', openNewMemberModal);
        document.querySelector('.close-modal').addEventListener('click', closeModal);
        document.querySelector('.close-modal-btn').addEventListener('click', closeModal);
        document.getElementById('save-member').addEventListener('click', (e) => {
            e.preventDefault();
            if (memberForm.checkValidity()) {
                saveMember();
            } else {
                alert('Por favor complete todos los campos obligatorios');
                const submitButton = document.createElement('button');
                submitButton.style.display = 'none';
                memberForm.appendChild(submitButton);
                submitButton.click();
                memberForm.removeChild(submitButton);
            }
        });

        // Llamar a la función para obtener los datos al cargar la página
        fetchMembers();

        // Función para filtrar los datos
        function filterData() {
            const searchTerm = searchInput.value.toLowerCase();
            filteredData = membersData.filter(member => {
                return (
                    member.clave.toLowerCase().includes(searchTerm) ||
                    member.nombre.toLowerCase().includes(searchTerm) ||
                    member.correo.toLowerCase().includes(searchTerm) ||
                    member.tipo.toLowerCase().includes(searchTerm) ||
                    member.area.toLowerCase().includes(searchTerm)
                );
            });

            currentPage = 1;
            renderTable();
        }

        // Función para abrir el modal en modo nuevo miembro
        function openNewMemberModal() {
            // Establecemos que estamos en modo de creación
            editModeInput.value = 'false'; // No es edición
            modalTitle.textContent = 'Registrar Nuevo Miembro'; // Cambiar título
            memberForm.reset(); // Limpiamos el formulario
            memberModal.classList.add('active'); // Mostramos el modal
        }

        // Función para abrir el modal en modo edición
        function openEditModal(clave) {
            const member = membersData.find(m => m.clave === clave);

            if (member) {
                // Establecemos que estamos en modo de edición
                editModeInput.value = 'true'; // Modo edición
                modalTitle.textContent = 'Editar Miembro'; // Cambiar título

                // Rellenar los campos con los datos del miembro
                document.getElementById('member-clave').value = member.clave;
                document.getElementById('member-nombre').value = member.nombre;
                document.getElementById('member-correo').value = member.correo;
                document.querySelector(`input[name="member-genero"][value="${member.genero}"]`).checked = true;
                document.getElementById('member-tipo').value = member.tipo;
                document.getElementById('member-edad').value = member.edad;
                document.getElementById('member-area').value = member.area;
                document.getElementById('member-estado').value = member.estado;

                memberModal.classList.add('active'); // Mostrar el modal
            }
        }

        // Función para cerrar el modal
        function closeModal() {
            memberModal.classList.remove('active'); // Ocultar el modal
            memberForm.reset(); // Limpiar formulario al cerrarlo
        }

        // Event listeners

        // Abrir el modal para registrar un nuevo miembro
        newMemberBtn.addEventListener('click', openNewMemberModal);

        // Cerrar el modal
        document.querySelector('.close-modal').addEventListener('click', closeModal);
        document.querySelector('.close-modal-btn').addEventListener('click', closeModal);

        // Guardar el miembro (nuevo o editado)
        document.getElementById('save-member').addEventListener('click', (e) => {
            e.preventDefault();

            // Validar formulario
            if (memberForm.checkValidity()) {
                saveMember();
            } else {
                alert('Por favor complete todos los campos obligatorios');
            }
        });

        // Función para guardar un miembro (nuevo o editado)
        function saveMember() {
            // Obtener los valores del formulario
            const clave = document.getElementById('member-clave').value;
            const nombre = document.getElementById('member-nombre').value;
            const correo = document.getElementById('member-correo').value;
            const genero = document.querySelector('input[name="member-genero"]:checked').value;
            const tipo = document.getElementById('member-tipo').value;
            const edad = parseInt(document.getElementById('member-edad').value);
            const area = document.getElementById('member-area').value;
            const estado = document.getElementById('member-estado').value;

            const member = {
                clave,
                nombre,
                correo,
                genero,
                tipo,
                edad,
                area,
                estado
            };

            const isEditMode = editModeInput.value === 'true';

            if (isEditMode) {
                // Actualizar miembro existente
                const index = membersData.findIndex(m => m.clave === clave);
                if (index !== -1) {
                    membersData[index] = member;
                }
            } else {
                // Verificar si la clave ya existe
                const exists = membersData.some(m => m.clave === clave);
                if (exists) {
                    alert('¡Error! Ya existe un miembro con esa clave.');
                    return;
                }
                // Agregar nuevo miembro
                membersData.push(member);
            }

            // Actualizar los datos filtrados y la tabla
            filteredData = [...membersData];
            if (searchInput.value) {
                filterData();
            } else {
                renderTable();
            }

            // Cerrar el modal
            closeModal();
        }

    </script>

</body>

</html>