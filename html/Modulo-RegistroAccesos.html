<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../img/sares.jpeg" type="image/x-icon">
    <link rel="stylesheet" href="../css/Modulo-RegistroAccesos.css">
    <link rel="stylesheet" href="../css/genericDesign.css">
    <title>Registro Accesos</title>
</head>
<body>
    <div class="header">
        <div class="logos">
            <img src="../img/sep.png" alt="Logo SEP">
            <img src="../img/tecnm.jpg" alt="TECNM Logo">
            <img src="../img/tec.png" alt="ITL Logo">
            <img src="../img/sares.jpeg" alt="SARES Logo">
        </div>
        <div class="user-profile" onclick="toggleMenu()">
            <img src="" alt="Foto de Perfil" id="profileImage">
            <span class="menu-icon"><img src="../img/list.svg"></span>
        </div>
        <div class="menu-dropdown" id="menuDropdown">
            <ul id="menuList">
                <!-- Contenido dinámico del menú -->
            </ul>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <h1 class="title">Registro de entrada y salida</h1>

            <!-- Fecha y hora actual -->
            <div class="datetime-container">
                <div class="date-box">
                    <h3>Fecha:</h3>
                    <div class="date-value" id="current-date"></div>
                </div>
                <div class="time-box">
                    <h3>Hora:</h3>
                    <div class="time-value" id="current-time"></div>
                </div>
            </div>

            <!-- Pestañas para elegir método de registro -->
            <div class="tab-container">
                <div class="tab active" data-tab="manual">Registro Manual</div>
                <div class="tab" data-tab="scanner">Escanear Código</div>
            </div>

            <!-- Contenido de la pestaña de registro manual -->
            <div class="tab-content active" id="manual-tab">
                <div class="input-section">
                    <div class="input-container">
                        <input type="text" class="input-field" placeholder="Ingresar clave..." id="manual-input">
                    </div>
                    <div class="select-container">
                        <select class="select-field" id="entry-type">
                            <option value="entrada">Entrada</option>
                            <option value="salida">Salida</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="register-btn">Registrar</button>
                </div>
            </div>

            <!-- Contenido de la pestaña de escáner -->
            <div class="tab-content" id="scanner-tab">
                <div class="scanner-section">
                    <div class="scanner-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                            <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                            <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                            <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                            <rect width="10" height="8" x="7" y="8" rx="1"></rect>
                        </svg>
                        Escanear Código de Barras
                    </div>
                    <div class="scanner-container">
                        <video id="scanner-video" autoplay playsinline></video>
                        <div class="scanner-overlay" id="scanner-overlay">
                            <p class="scanner-message">Cámara no activada</p>
                            <div class="scanner-buttons">
                                <button class="btn btn-primary" id="start-scanner">Iniciar Cámara</button>
                            </div>
                        </div>
                    </div>
                    <div class="select-container">
                        <select class="select-field" id="scanner-entry-type">
                            <option value="entrada">Entrada</option>
                            <option value="salida">Salida</option>
                        </select>
                    </div>
                    <div class="input-container">
                        <input type="text" class="input-field" placeholder="Código escaneado..." id="scanner-result" readonly>
                    </div>
                    <button class="btn btn-primary" id="register-scan-btn">Registrar</button>
                </div>
            </div>

            <!-- Último registro -->
            <div class="last-scan">
                <h3>Último Registro</h3>
                <div class="last-scan-info">
                    <div class="last-scan-item">
                        <div class="last-scan-label">Clave</div>
                        <div class="last-scan-value" id="last-code">-</div>
                    </div>
                    <div class="last-scan-item">
                        <div class="last-scan-label">Tipo</div>
                        <div class="last-scan-value" id="last-type">-</div>
                    </div>
                    <div class="last-scan-item">
                        <div class="last-scan-label">Hora</div>
                        <div class="last-scan-value" id="last-time">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">© Sares TL, 2024</div>

    <!-- Script para implementar el escáner con QuaggaJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        // Alternar el menú desplegable
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('open');
        }

        // Función para actualizar la fecha y hora
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString("es-ES");
            const timeStr = now.toLocaleTimeString("es-ES");
            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('current-time').textContent = timeStr;
        }

        // Actualizar la fecha y hora cada segundo
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Función para cambiar las pestañas
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');

                // Si se selecciona la pestaña de escáner, detener la cámara
                if (tabId !== 'scanner' && window.scanner) {
                    stopScanner();
                }
            });
        });

        // Registrar entrada manual
        document.getElementById('register-btn').addEventListener('click', () => {
            const code = document.getElementById('manual-input').value;
            const type = document.getElementById('entry-type').value;  // Obtener el tipo desde el selector
            const time = document.getElementById('current-time').value // Hora actual 
            const date = document.getElementById('current-date').value // Fecha actual
            message = "Vacio";
            if (type === "entrada") {
                message = "Usted ha realizado un registro de entrada el dia: " + date + " a las: " + time;
            } else if (type === "salida") {
                message = "Usted ha realizado un registro de salida el dia: " + date + " a las: " + time; 
            }           

            registerEntry(code, time, date, type, message);
        });

        // Registrar entrada por escáner
        document.getElementById('register-scan-btn').addEventListener('click', () => {
            const code = document.getElementById('scanner-result').value;
            const type = document.getElementById('scanner-entry-type').value;  // Obtener el tipo desde el selector
            const time = document.getElementById('current-time').value // Hora actual 
            const date = document.getElementById('current-date').value // Fecha actual
            message = "Vacio";
            if (type === "entrada") {
                message = "Usted ha realizado un registro de entrada el dia: " + date + " a las: " + time;
            } else if (type === "salida") {
                message = "Usted ha realizado un registro de salida el dia: " + date + " a las: " + time; 
            }  

            registerEntry(code, time, date, type, message);
        });

        // Función para registrar entrada en la base de datos
        async function registerEntry(clave, hr, date, typeR, message) {
            if (!clave || !hr || !date || !typeR || !message) {
                alert('Faltan datos para registrar la entrada.');
                return;
            }

            try {
                const response = await fetch('https://hugoc.pythonanywhere.com/api/register_entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clave,
                        hr,
                        date,
                        typeR,
                        message
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Registro exitoso');
                    document.getElementById('last-code').textContent = clave;
                    document.getElementById('last-type').textContent = typeR;
                    document.getElementById('last-time').textContent = hr;
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
                alert('Error al registrar el acceso.');
            }
        }

        // Iniciar el escáner
        let videoStream;
        document.getElementById('start-scanner').addEventListener('click', () => {
            startScanner();
        });

        function startScanner() {
            const scannerMessage = document.getElementById('scanner-overlay');
            scannerMessage.style.display = 'none';
            const video = document.getElementById('scanner-video');

            // Acceder a la cámara
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then((stream) => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play();

                    // Iniciar Quagga para el escaneo de código de barras
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: video,    // HTML video element
                            constraints: {
                                facingMode: "environment"
                            }
                        },
                        decoder: {
                            readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"] // Agregar más tipos según sea necesario
                        },
                    }, function(err) {
                        if (err) {
                            console.error(err);
                            alert('Error al iniciar el escáner.');
                            return;
                        }
                        Quagga.start();
                    });

                    // Procesar el código escaneado
                    Quagga.onDetected(function(result) {
                        const code = result.codeResult.code;
                        document.getElementById('scanner-result').value = code;
                    });
                })
                .catch((err) => {
                    console.error('Error al acceder a la cámara', err);
                    alert('No se pudo acceder a la cámara');
                });
        }

        // Detener el escáner
        function stopScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            Quagga.stop();
        }
    </script>
</body>
</html>
