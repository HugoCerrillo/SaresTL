<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../img/sares.jpeg" type="image/x-icon">
    <link rel="stylesheet" href="../css/genericDesign.css">
    <link rel="stylesheet" href="../css/Modulo-VisualizacionGeneral.css">
    <title>Visualización General</title>
</head>

<body>
    <div class="header">
        <div class="logos">
            <img src="../img/sep.png" alt="Logo SEP">
            <img src="../img/tecnm.jpg" alt="TECNM Logo">
            <img src="../img/tec.png" alt="ITL Logo">
            <img src="../img/sares.jpeg" alt="SARES Logo">
        </div>
        <div class="user-profile" onclick="toggleMenu()">
            <img src="" alt="Foto de Perfil" id="profileImage">
            <span class="menu-icon"><img src="../img/list.svg"></span>
        </div>
        <div class="menu-dropdown" id="menuDropdown">
            <ul id="menuList">
                <!-- Contenido dinámico del menú -->
            </ul>
        </div>
    </div>


    <!-- Contenido principal -->
    <div class="main-content">
        <div class="welcome-text">
            <h1 id="bienvenida">Visualización General </h1>
        </div>
        <!-- Tabla de datos -->
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">Listado de Datos</h2>
                <input type="text" class="search-box" placeholder="Buscar..." id="searchInput">
            </div>

            <table id="dataTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Departamento</th>
                        <th>Rol</th>
                        <th>Estatus</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos se cargarán con JavaScript -->
                </tbody>
            </table>

            <div class="pagination">
                <button class="page-btn">Anterior</button>
                <button class="page-btn active">1</button>
                <button class="page-btn">2</button>
                <button class="page-btn">3</button>
                <button class="page-btn">Siguiente</button>
            </div>
        </div>

    </div>
    <!-- Modal para editar registro -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Editar Registro</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label for="editNombre">Nombre:</label>
                        <input type="text" id="editNombre" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editDepartamento">Departamento:</label>
                        <input type="text" id="editDepartamento" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editRol">Rol:</label>
                        <select id="editRol" class="form-control" required>
                            <option value="Administrador">Administrador</option>
                            <option value="Usuario">Usuario</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Técnico">Técnico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editEstatus">Estatus:</label>
                        <select id="editEstatus" class="form-control" required>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-primary" id="saveEdit">Guardar
                    Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar eliminación -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar Eliminación</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar este registro? Esta
                    acción no se puede deshacer.</p>
                <input type="hidden" id="deleteId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancelar</button>
                <button class="btn btn-danger" id="confirmDelete">Eliminar</button>
            </div>
        </div>
    </div>

    <div class="footer">© Sares TL, 2024</div>

    <script>
        // Función para alternar el menú desplegable
        function toggleMenu() {
            const menu = document.getElementById('menuDropdown');
            menu.classList.toggle('open');
        }

        // Función para obtener datos del usuario y generar contenido dinámico
        async function obtenerDatosUsuario() {
            const user = sessionStorage.getItem('user'); // Obtener el ID del usuario

            // Verifica si el usuario no está autenticado
            if (!user) {
                alert('No has iniciado sesión. Redirigiendo al login...');
                window.location.href = "../html/Modulo-InicioSesion.html"; // Redirección al login
                return;
            }

            // URL del API para obtener tipo de usuario
            const apiUrl = 'https://hugoc.pythonanywhere.com/api/usertype';

            try {
                // Realiza la solicitud POST para obtener el tipo de usuario
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user }),
                });

                const data = await response.json();
                if (response.ok && data.status === "success") {
                    const userRoleNumber = data.userRole ?? '';
                    const userName = data.userName ?? '';
                    const userTypeInst = data.userTypeInst ?? '';

                    try {
                        // Realiza la solicitud para obtener la imagen del usuario
                        const apiUrlPicture = 'https://hugoc.pythonanywhere.com/api/userPicture';
                        const responsePicture = await fetch(apiUrlPicture, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ user }),
                        });
                        const dataPicture = await responsePicture.json();

                        if (responsePicture.ok && dataPicture.status === "success") {
                            const userPicture = dataPicture.userPicture ?? '';

                            // Verifica que profileImage exista en el DOM
                            const profileImage = document.querySelector('.user-profile img');
                            if (profileImage) {
                                profileImage.src = userPicture; // Actualiza la imagen de perfil
                            } else {
                                console.error('No se encontró el elemento de la imagen de perfil');
                            }
                        } else {
                            console.error('Error al obtener la imagen de perfil:', dataPicture.message);
                        }

                    } catch (errorP) {
                        console.error('Error en la solicitud de la imagen de perfil:', errorP);
                        alert('Hubo un problema al conectar con el servidor para obtener la imagen de perfil. Intenta nuevamente.');
                    }
                    switch (userRoleNumber) {
                        case 1:
                            generarMenu('Estudiante');
                            break;
                        case 2:
                            generarMenu('Docente');
                            break;
                        case 3:
                            generarMenu('Administrador');
                            break;
                        case 4:
                            generarMenu('Administrativo');
                            break;
                        case 5:
                            generarMenu('Intendente');
                            break;
                        case 6:
                            generarMenu('Guardia');
                            break;
                        default:
                            console.error('Rol de usuario desconocido');
                            alert('No se pudo determinar el rol del usuario.');
                            window.location.href = "../html/Modulo-InicioSesion.html"; // Redirige si hay error
                            break;
                    }

                } else {
                    console.error('Error al obtener tipo de usuario:', data.message);
                    alert('Hubo un problema al obtener el tipo de usuario. Intenta nuevamente.');
                    window.location.href = "../html/Modulo-InicioSesion.html"; // Redirige si la respuesta no es correcta
                }

            } catch (error) {
                console.error('Error en la solicitud principal:', error);
                alert('Hubo un problema al conectar con el servidor. Intenta nuevamente.');
                window.location.href = "../html/Modulo-InicioSesion.html"; // Redirige en caso de error
            }

        }

        // Función para generar el menú dinámico según el rol del usuario
        function generarMenu(userRole) {
            const menuDropdown = document.getElementById('menuDropdown');
            //const menuList = menuDropdown.querySelector('ul');

            // Generar contenido según el rol del usuario
            if (userRole === 'Administrador') {
                menuList.innerHTML = `
                    <li><a href="../html/Modulo-Bienvenida.html">Panel Principal</a></li>
                    <li><a href="../html/Modulo-VisualizacionGeneral.html">Visualización Entradas y Salidas</a></li>
                    <li><a href="../html/Modulo-RevisarHistorial.html">Revisar Historial Personal</a></li>
                    <li><a href="../html/Modulo-RegistrarNuevoMiembro.html">Registrar Miembro Institución</a></li>
                    <li><a href="../html/Modulo-Perfil.html">Perfil</a></li>                    
                    <li><a href="../html/Modulo-ManualUsuario.html">Manual de Usuario</a></li>
                    <li><a href="../html/Modulo-InicioSesion.html" onclick="logOut()">Cerrar Sesión</a></li>
                `;
            } else if (userRole == 'Guardia') {
                menuList.innerHTML = `
                    <li><a href="../html/Modulo-Bienvenida.html">Panel Principal</a></li>
                    <li><a href="../html/Modulo-RegistroAccesos.html">Registro Accesos</a></li>   
                    <li><a href="../html/Modulo-VisualizacionGeneral.html">Visualización Entradas y Salidas</a></li>
                    <li><a href="../html/Modulo-RevisarHistorial.html">Revisar Historial Personal</a></li>
                    <li><a href="../html/Modulo-Perfil.html">Perfil</a></li>                    
                    <li><a href="../html/Modulo-ManualUsuario.html">Manual de Usuario</a></li>
                    <li><a href="../html/Modulo-InicioSesion.html" onclick="logOut()">Cerrar Sesión</a></li>
                `;

            } else {
                menuList.innerHTML = `
                    <li><a href="../html/Modulo-Bienvenida.html">Panel Principal</a></li>                                          
                    <li><a href="../html/Modulo-RevisarHistorial.html">Revisar Historial Personal</a></li>
                    <li><a href="../html/Modulo-Perfil.html">Perfil</a></li>                    
                    <li><a href="../html/Modulo-ManualUsuario.html">Manual de Usuario</a></li>
                    <li><a href="../html/Modulo-InicioSesion.html" onclick="logOut()">Cerrar Sesión</a></li>
                `;
            }
        }
        function logOut() {
            // Limpiar el sessionStorage y redirigir al inicio de sesión
            sessionStorage.clear();
        }

        // Llamar a la función al cargar la página
        obtenerDatosUsuario();

        // URL de la API
        const apiUrl = "https://hugoc.pythonanywhere.com/api/get_general_registration";

        // Función para cargar los datos desde la API
        async function loadTableData() {
            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
                const data = await response.json();

                // Comprobar si la respuesta fue exitosa
                if (data.status === "success") {
                    const records = data.records;
                    displayTable(records);  // Función para mostrar la tabla con los datos
                } else {
                    alert("Error al cargar los registros.");
                }
            } catch (error) {
                console.error("Error en la carga de datos:", error);
                alert("No se pudo obtener los datos de los registros.");
            }
        }

        // Función para mostrar los datos en la tabla
        function displayTable(data) {
            const tableBody = document.querySelector("#dataTable tbody");
            tableBody.innerHTML = "";

            data.forEach(item => {
                const row = document.createElement("tr");

                const idCell = document.createElement("td");
                idCell.textContent = item.idRegistro;

                const nombreCell = document.createElement("td");
                nombreCell.textContent = item.nombreUsuario;

                const deptoCell = document.createElement("td");
                deptoCell.textContent = item.departamento;  // Asegúrate que este campo esté disponible en tu respuesta.

                const rolCell = document.createElement("td");
                rolCell.textContent = item.tipoUsuario;

                const estatusCell = document.createElement("td");
                estatusCell.textContent = item.tipoR;

                const accionesCell = document.createElement("td");

                // Botón de editar
                const editBtn = document.createElement("button");
                editBtn.className = "action-btn";
                editBtn.textContent = "Editar";
                editBtn.addEventListener("click", () => openEditModal(item));

                // Botón de eliminar
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "action-btn delete-btn";
                deleteBtn.textContent = "Eliminar";
                deleteBtn.addEventListener("click", () => openDeleteModal(item.idRegistro));

                accionesCell.appendChild(editBtn);
                accionesCell.appendChild(deleteBtn);

                row.appendChild(idCell);
                row.appendChild(nombreCell);
                row.appendChild(deptoCell);
                row.appendChild(rolCell);
                row.appendChild(estatusCell);
                row.appendChild(accionesCell);

                tableBody.appendChild(row);
            });
        }

        // Función para abrir el modal de edición
        function openEditModal(item) {
            document.getElementById("editId").value = item.idRegistro;
            document.getElementById("editNombre").value = item.nombreUsuario;
            document.getElementById("editDepartamento").value = item.departamento;
            document.getElementById("editRol").value = item.tipoUsuario;
            document.getElementById("editEstatus").value = item.tipoR;

            document.getElementById("editModal").classList.add("active");
        }

        // Función para guardar los cambios de edición
        async function saveEdit() {
            const id = document.getElementById("editId").value;
            const nombre = document.getElementById("editNombre").value;
            const departamento = document.getElementById("editDepartamento").value;
            const rol = document.getElementById("editRol").value;
            const estatus = document.getElementById("editEstatus").value;

            // Crear un objeto con los datos actualizados
            const updatedData = {
                idRegistro: id,
                nombreUsuario: nombre,
                departamento: departamento,
                tipoUsuario: rol,
                tipoR: estatus
            };

            try {
                const response = await fetch(`https://hugoc.pythonanywhere.com/api/update_registration/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();
                if (result.status === "success") {
                    alert("Registro actualizado correctamente.");
                    loadTableData();  // Recargar la tabla
                    closeModals();
                } else {
                    alert("Error al actualizar el registro.");
                }
            } catch (error) {
                console.error("Error al actualizar el registro:", error);
                alert("No se pudo actualizar el registro.");
            }
        }

        // Función para abrir el modal de eliminación
        function openDeleteModal(id) {
            document.getElementById("deleteId").value = id;
            document.getElementById("deleteModal").classList.add("active");
        }

        // Función para confirmar la eliminación
        async function confirmDelete() {
            const id = document.getElementById("deleteId").value;

            try {
                const response = await fetch(`https://hugoc.pythonanywhere.com/api/delete_registration/${id}`, {
                    method: "DELETE"
                });

                const result = await response.json();
                if (result.status === "success") {
                    alert("Registro eliminado correctamente.");
                    loadTableData();  // Recargar la tabla
                    closeModals();
                } else {
                    alert("Error al eliminar el registro.");
                }
            } catch (error) {
                console.error("Error al eliminar el registro:", error);
                alert("No se pudo eliminar el registro.");
            }
        }

        // Función para cerrar los modales
        function closeModals() {
            document.querySelectorAll(".modal-overlay").forEach(modal => {
                modal.classList.remove("active");
            });
        }

        // Función para filtrar los datos en tiempo real
        function filterData() {
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("keyup", function () {
                const searchTerm = this.value.toLowerCase();
                const filteredData = sampleData.filter(item => {
                    return (
                        item.nombreUsuario.toLowerCase().includes(searchTerm) ||
                        item.departamento.toLowerCase().includes(searchTerm) ||
                        item.tipoUsuario.toLowerCase().includes(searchTerm) ||
                        item.tipoR.toLowerCase().includes(searchTerm)
                    );
                });
                loadTableData(filteredData);
            });
        }

        // Inicialización
        document.addEventListener("DOMContentLoaded", function () {
            loadTableData();  // Cargar los datos al cargar la página
            filterData();     // Activar filtro en tiempo real

            // Event listeners para los botones de los modales
            document.getElementById("saveEdit").addEventListener("click", saveEdit);
            document.getElementById("confirmDelete").addEventListener("click", confirmDelete);

            // Event listeners para cerrar los modales
            document.querySelectorAll(".close-modal").forEach(button => {
                button.addEventListener("click", closeModals);
            });
        });
    </script>
</body>

</html>